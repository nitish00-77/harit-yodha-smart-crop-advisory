<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>हरित - आपका कृषि सहायक (Professional Prototype)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: linear-gradient(rgba(240, 253, 244, 0.97), rgba(240, 253, 244, 0.97)), url('https://images.unsplash.com/photo-1499529112087-7cb3b7874405?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .glass { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .assistant-btn-glow {
            box-shadow: 0 0 25px 10px rgba(34, 197, 94, 0.7);
            animation: pulse-glow 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 25px 10px rgba(34, 197, 94, 0.7); }
            50% { box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.4); }
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #22c55e; border-radius: 50%;
            width: 32px; height: 32px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .timeline { position: relative; padding: 1rem 0; }
        .timeline::before { content: ''; position: absolute; top: 0; left: 18px; height: 100%; width: 4px; background: #cbd5e1; }
        .timeline-item { position: relative; margin-bottom: 1.5rem; }
        .timeline-icon { position: absolute; left: 0; top: 0; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; color: white; z-index: 10; border: 4px solid #f0f9ff; }
        .timeline-content { margin-left: 60px; padding: 0.5rem 1rem; background: #f0f9ff; border-radius: 0.5rem; }
        .timeline-category { font-size: 0.75rem; font-weight: bold; text-transform: uppercase; color: #3b82f6; }
    </style>
</head>
<body class="bg-green-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-6xl font-bold text-green-800">हरित - आपका कृषि सहायक</h1>
            <p class="text-gray-600 mt-2 text-lg">भारत के किसानों के लिए एक संपूर्ण डिजिटल समाधान।</p>
        </header>

        <div id="messageBox" class="fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-lg z-50 text-white transition-opacity duration-300 opacity-0" role="alert"></div>

        <div class="text-center mb-10">
            <button id="assistantBtn" class="bg-green-600 text-white font-bold py-4 px-8 rounded-full shadow-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all duration-300 transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 inline-block mr-3" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 11.5a4.5 4.5 0 009 0H16a6 6 0 01-12 0h1.5z" /><path d="M10 18a3 3 0 003-3h-1.5a1.5 1.5 0 01-3 0H7a3 3 0 003 3z" /></svg>
                सहायक को सक्रिय करें
            </button>
            <p id="status" class="mt-4 text-gray-600 h-6 transition-opacity duration-300"></p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
            
            <div class="glass p-6 rounded-2xl shadow-md">
                <h2 class="text-2xl font-bold text-green-700 mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" /></svg>मौसम और सिंचाई सलाह</h2>
                <div class="flex gap-2 mb-4"><input type="text" id="cityInput" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="शहर का नाम"><button id="getWeatherBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">खोजें</button></div>
                <div id="weatherResult" class="text-gray-700 space-y-2"></div>
                <div id="irrigationAdvisory" class="mt-4"></div>
            </div>

            <div class="glass p-6 rounded-2xl shadow-md">
                <h2 class="text-2xl font-bold text-green-700 mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>व्यक्तिगत फसल कैलेंडर</h2>
                <div class="space-y-4">
                    <div><label for="calendarCrop" class="block mb-1 font-medium">फसल:</label><select id="calendarCrop" class="w-full p-2 border border-gray-300 rounded-lg"></select></div>
                    <div><label for="sowingDate" class="block mb-1 font-medium">बुवाई की तारीख:</label><input type="date" id="sowingDate" class="w-full p-2 border border-gray-300 rounded-lg"></div>
                    <button id="generateCalendarBtn" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">कैलेंडर बनाएं</button>
                </div>
            </div>

            <div class="glass p-6 rounded-2xl shadow-md">
                <h2 class="text-2xl font-bold text-green-700 mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6H8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9" /></svg>फसल सुझाव</h2>
                <div class="space-y-4">
                    <div><label for="soilType" class="block mb-1 font-medium">मिट्टी का प्रकार:</label><select id="soilType" class="w-full p-2 border border-gray-300 rounded-lg"><option value="काली">काली</option><option value="जलोढ़">जलोढ़</option><option value="लाल">लाल</option><option value="लेटराइट">लेटराइट</option></select></div>
                    <div><label for="season" class="block mb-1 font-medium">मौसम:</label><select id="season" class="w-full p-2 border border-gray-300 rounded-lg"><option value="रबी">रबी (सर्दी)</option><option value="खरीफ">खरीफ (वर्षा)</option><option value="जायद">जायद (गर्मी)</option></select></div>
                    <button id="getCropBtn" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">सुझाव प्राप्त करें</button>
                </div>
                <div id="cropResult" class="mt-4 text-gray-700"></div>
            </div>

            <div class="glass p-6 rounded-2xl shadow-md">
                <h2 class="text-2xl font-bold text-green-700 mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7.014A8.003 8.003 0 0117.657 18.657z" /><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 16.121A3 3 0 1014.12 11.88a3 3 0 00-4.242 4.242z" /></svg>खाद और मिट्टी स्वास्थ्य</h2>
                 <div class="space-y-4">
                     <div><label for="fertilizerCrop" class="block mb-1 font-medium">फसल:</label><select id="fertilizerCrop" class="w-full p-2 border border-gray-300 rounded-lg"></select></div>
                    <button id="getFertilizerBtn" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">जानकारी प्राप्त करें</button>
                </div>
                <div id="fertilizerResult" class="mt-4 text-gray-700"></div>
            </div>
            
            <div class="glass p-6 rounded-2xl shadow-md">
                <h2 class="text-2xl font-bold text-green-700 mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>पौधे का निदान</h2>
                <div class="space-y-4"><p class="text-gray-600">बीमारी की पहचान के लिए पौधे का फोटो अपलोड करें।</p><input type="file" id="plantPhotoInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 transition"/><button id="diagnoseBtn" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">निदान करें</button><div id="diagnosisResult" class="mt-4 text-gray-700"></div></div>
            </div>

            <div class="glass p-6 rounded-2xl shadow-md">
                <h2 class="text-2xl font-bold text-green-700 mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 8h6m-5 3h4m1 1l1 1h4l-1-1zm-6-3l-1-1H3l1 1zm-3 4h18a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v2a2 2 0 002 2z" /></svg>बाजार मूल्य पूर्वानुमान</h2>
                <div class="space-y-4">
                    <div><label for="marketCropSelect" class="block mb-1 font-medium">फसल:</label><select id="marketCropSelect" class="w-full p-2 border border-gray-300 rounded-lg"></select></div>
                    <div><label for="cityInputMarket" class="block mb-1 font-medium">शहर:</label><input type="text" id="cityInputMarket" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="उदा. दिल्ली"></div>
                    <button id="getMarketPriceBtn" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">मूल्य प्राप्त करें</button>
                </div>
                <div id="marketPriceResult" class="mt-4 text-gray-700"></div><div id="marketPricePrediction" class="mt-4 text-gray-700"></div>
            </div>
            
             <div class="glass p-6 rounded-2xl shadow-md">
                <h2 class="text-2xl font-bold text-green-700 mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>उपज का पूर्वानुमान</h2>
                <div class="space-y-4">
                    <div><label for="yieldCrop" class="block mb-1 font-medium">फसल:</label><select id="yieldCrop" class="w-full p-2 border border-gray-300 rounded-lg"></select></div>
                    <div><label for="farmSize" class="block mb-1 font-medium">खेत का आकार (एकड़ में):</label><input type="number" id="farmSize" class="w-full p-2 border border-gray-300 rounded-lg" value="1"></div>
                    <button id="predictYieldBtn" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">अनुमान लगाएं</button>
                </div>
                <div id="yieldResult" class="mt-4 text-gray-700"></div>
            </div>
            
            <div class="glass p-6 rounded-2xl shadow-md">
                <h2 class="text-2xl font-bold text-green-700 mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>डिजिटल बही-खाता</h2>
                <div class="space-y-3">
                    <div class="text-center p-2 rounded-lg bg-green-100">
                        <p class="text-sm font-medium text-gray-600">कुल लाभ/हानि</p>
                        <p id="profitText" class="text-2xl font-bold text-green-700">₹ 0</p>
                    </div>
                    <input type="text" id="transactionDesc" placeholder="विवरण (जैसे बीज, खाद)" class="w-full p-2 border rounded-lg">
                    <input type="number" id="transactionAmount" placeholder="राशि (₹)" class="w-full p-2 border rounded-lg">
                    <div class="flex gap-2">
                        <button id="addIncomeBtn" class="w-full bg-green-500 text-white py-2 rounded-lg hover:bg-green-600">आमदनी जोड़ें</button>
                        <button id="addExpenseBtn" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">खर्च जोड़ें</button>
                    </div>
                </div>
                <div id="transactionList" class="mt-4 text-sm max-h-24 overflow-y-auto"></div>
            </div>

            <div class="glass p-6 rounded-2xl shadow-md">
                <h2 class="text-2xl font-bold text-green-700 mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10l2-2h8a1 1 0 001-1z" /><path stroke-linecap="round" stroke-linejoin="round" d="M20 18.35V19a2 2 0 01-2 2h-1a1 1 0 01-1-1v-2.65M18 5.65V5a2 2 0 00-2-2h-1a1 1 0 00-1 1v2.65" /></svg>उपकरण रेंटल बाजार</h2>
                <div class="space-y-3">
                    <div class="p-3 bg-gray-100 rounded-lg flex justify-between items-center"><div><p class="font-bold">ट्रैक्टर</p><p class="text-sm">₹ 800 / घंटा</p></div><button class="bg-green-500 text-white px-3 py-1 text-sm rounded-lg" onclick="alert('सेवा प्रदाता से संपर्क किया जा रहा है...')">संपर्क</button></div>
                    <div class="p-3 bg-gray-100 rounded-lg flex justify-between items-center"><div><p class="font-bold">रोटावेटर</p><p class="text-sm">₹ 600 / घंटा</p></div><button class="bg-green-500 text-white px-3 py-1 text-sm rounded-lg" onclick="alert('सेवा प्रदाता से संपर्क किया जा रहा है...')">संपर्क</button></div>
                    <div class="p-3 bg-gray-100 rounded-lg flex justify-between items-center"><div><p class="font-bold">पानी का पंप</p><p class="text-sm">₹ 200 / दिन</p></div><button class="bg-green-500 text-white px-3 py-1 text-sm rounded-lg" onclick="alert('सेवा प्रदाता से संपर्क किया जा रहा है...')">संपर्क</button></div>
                </div>
            </div>
            
            <div class="glass p-6 rounded-2xl shadow-md flex flex-col">
                <h2 class="text-2xl font-bold text-green-700 mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a2 2 0 01-2-2V10a2 2 0 012-2h8z" /></svg>किसान समुदाय मंच</h2>
                <div id="forumPosts" class="space-y-3 flex-grow overflow-y-auto max-h-48 mb-4">
                    <div class="p-3 bg-blue-50 rounded-lg"><p class="font-bold text-sm">राम सिंह ने पूछा:</p><p class="text-sm">"मेरी टमाटर की फसल में पत्तियां सिकुड़ रही हैं, क्या करूँ?"</p></div>
                    <div class="p-3 bg-green-50 rounded-lg ml-4"><p class="font-bold text-sm">कृषि विशेषज्ञ ने जवाब दिया:</p><p class="text-sm">"यह लीफ कर्ल वायरस हो सकता है। इमिडाक्लोप्रिड का छिड़काव करें।"</p></div>
                </div>
                <div class="mt-auto space-y-2">
                    <textarea id="forumQuestion" class="w-full p-2 border rounded-lg" placeholder="अपना सवाल यहाँ लिखें..." rows="2"></textarea>
                    <button id="postQuestionBtn" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">सवाल पूछें</button>
                </div>
            </div>

            <div class="glass p-6 rounded-2xl shadow-md">
                <h2 class="text-2xl font-bold text-green-700 mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>सरकारी योजनाएं</h2>
                <div class="space-y-2 text-gray-700">
                    <div class="p-2 bg-green-50 rounded-lg"><h3 class="font-bold">PM-KISAN</h3><p class="text-sm">किसानों को प्रति वर्ष ₹6,000 की वित्तीय सहायता। <a href="https://pmkisan.gov.in/" target="_blank" class="text-blue-600">अधिक जानें</a></p></div>
                    <div class="p-2 bg-green-50 rounded-lg"><h3 class="font-bold">PMFBY</h3><p class="text-sm">फसल के नुकसान पर बीमा कवरेज। <a href="https://pmfby.gov.in/" target="_blank" class="text-blue-600">अधिक जानें</a></p></div>
                    <div class="p-2 bg-green-50 rounded-lg"><h3 class="font-bold">KCC</h3><p class="text-sm">कम ब्याज दर पर कृषि ऋण। <a href="https://www.sbi.co.in/web/agri-rural/agriculture-banking/crop-finance/kisan-credit-card" target="_blank" class="text-blue-600">अधिक जानें</a></p></div>
                </div>
            </div>
            
            <div class="glass p-6 rounded-2xl shadow-md">
                 <h2 class="text-2xl font-bold text-green-700 mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>महत्वपूर्ण हेल्पलाइन</h2>
                <div class="space-y-4">
                    <div><h3 class="font-bold">किसान कॉल सेंटर</h3><p class="text-sm">कृषि संबंधी किसी भी प्रश्न के लिए।<br><a href="tel:18001801551" class="font-semibold text-green-600">📞 1800-180-1551</a></p></div>
                    <div><h3 class="font-bold">कृषि और किसान कल्याण</h3><p class="text-sm">मंत्रालय से संबंधित प्रश्नों के लिए।<br><a href="tel:1800110039" class="font-semibold text-green-600">📞 1800-11-0039</a></p></div>
                </div>
            </div>

             <div class="glass p-6 rounded-2xl shadow-md">
                <h2 class="text-2xl font-bold text-green-700 mb-4 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1h4v1m-4 0h-4v-1h4m0-4.03c-3.132 0-6 2.688-6 6s2.868 6 6 6 6-2.688 6-6-2.868-6-6-6z" /></svg>फसल की कुल लागत</h2>
                <div class="space-y-4">
                    <p class="text-gray-600">फसल की अनुमानित लागत की गणना करें।</p>
                    <button id="openCostCalculatorBtn" class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">लागत की गणना करें</button>
                </div>
            </div>

        </div>
    </div>

    <div id="calendarModal" class="fixed inset-0 z-50 modal-backdrop items-center justify-center p-4 hidden"><div class="glass w-full max-w-2xl rounded-2xl shadow-lg p-6 relative"><button id="closeCalendarModalBtn" class="absolute top-4 right-4 text-2xl font-bold text-gray-600 hover:text-gray-900">&times;</button><h2 id="modalTitle" class="text-2xl font-bold text-green-700 mb-4">फसल कैलेंडर</h2><div id="modalContent" class="space-y-3 max-h-96 overflow-y-auto"></div></div></div>
    <div id="costCalculatorModal" class="fixed inset-0 z-50 modal-backdrop items-center justify-center p-4 hidden"><div class="glass w-full max-w-lg rounded-2xl shadow-lg p-6 relative"><button id="closeCostModalBtn" class="absolute top-4 right-4 text-2xl font-bold text-gray-600 hover:text-gray-900">&times;</button><h2 class="text-2xl font-bold text-green-700 mb-4">फसल लागत कैलकुलेटर</h2><div class="space-y-3"><div class="grid grid-cols-2 gap-4"><input type="number" id="cost_seed" placeholder="बीज (₹)" class="p-2 border rounded"><input type="number" id="cost_fertilizer" placeholder="उर्वरक (₹)" class="p-2 border rounded"><input type="number" id="cost_pesticide" placeholder="कीटनाशक (₹)" class="p-2 border rounded"><input type="number" id="cost_labor" placeholder="श्रम (₹)" class="p-2 border rounded"><input type="number" id="cost_irrigation" placeholder="सिंचाई (₹)" class="p-2 border rounded"><input type="number" id="cost_other" placeholder="अन्य (₹)" class="p-2 border rounded"></div><button id="calculateCostBtn" class="w-full bg-blue-500 text-white py-2 mt-4 rounded-lg">गणना करें</button><div id="totalCostResult" class="mt-4 text-center text-lg font-bold"></div></div></div></div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {

    const ICONS = {
        irrigation: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM6.625 9.328a.75.75 0 01.04-1.06l.059-.059a.748.748 0 011.058.02L10 10.43l2.218-2.18a.748.748 0 011.058-.02l.059.059a.75.75 0 01.04 1.06l-2.25 2.25a.75.75 0 01-1.06 0l-2.25-2.25z" clip-rule="evenodd" /></svg>`,
        fertilizer: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 2zM5.106 5.106a.75.75 0 011.06 0l2.475 2.475a.75.75 0 01-1.06 1.06L5.106 6.166a.75.75 0 010-1.06zM2 10a.75.75 0 01.75-.75h3.5a.75.75 0 010 1.5h-3.5A.75.75 0 012 10zM14.894 5.106a.75.75 0 010 1.06l-2.475 2.475a.75.75 0 01-1.06-1.06L13.834 5.106a.75.75 0 011.06 0zM17.25 10a.75.75 0 01-.75.75h-3.5a.75.75 0 010-1.5h3.5a.75.75 0 01.75.75zM10 12a2 2 0 100 4 2 2 0 000-4zM5.106 14.894a.75.75 0 011.06 0l2.475-2.475a.75.75 0 011.06 1.06L6.166 14.894a.75.75 0 01-1.06 0zM14.894 14.894a.75.75 0 010-1.06l-2.475-2.475a.75.75 0 01-1.06 1.06l2.475 2.475a.75.75 0 010 1.06z" /></svg>`,
        pest_control: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.233 2.003a.75.75 0 01.22.13l5.5 5.5a.75.75 0 01-1.06 1.06L14 7.81V13a1 1 0 11-2 0V7.81l-.943.944a.75.75 0 11-1.06-1.06l2-2a.75.75 0 01.236-.13zm-6.5 1.5a.75.75 0 01.328-.623l5.5-3.5a.75.75 0 01.828.01l5.5 3.5a.75.75 0 01-.482 1.346L14 10.45V13a3 3 0 11-6 0v-2.55L6.425 8.19A.75.75 0 015 7.5v-2a.75.75 0 01.733-.747z" clip-rule="evenodd" /></svg>`,
        action: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1.5a.75.75 0 01.75.75V4h1.5a.75.75 0 010 1.5H12v1.5a.75.75 0 01-1.5 0V6h-1.5a.75.75 0 010-1.5H10V2.25A.75.75 0 0110 1.5zM5.878 6.122a.75.75 0 011.06 0l2.5 2.5a.75.75 0 010 1.06l-2.5 2.5a.75.75 0 01-1.06-1.06L7.81 9.25l-1.932-1.932a.75.75 0 010-1.06zM14.122 6.122a.75.75 0 010 1.06L12.19 9.25l1.932 1.932a.75.75 0 01-1.06 1.06l-2.5-2.5a.75.75 0 010-1.06l2.5-2.5a.75.75 0 011.06 0z" clip-rule="evenodd" /></svg>`,
        harvest: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M2.22 2.22a.75.75 0 011.06 0l14.5 14.5a.75.75 0 01-1.06 1.06L2.22 3.28a.75.75 0 010-1.06z" /><path d="M17.5 8.25a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H16V6a.75.75 0 011.5 0v2.25zM16 11.25a.75.75 0 01.75-.75h.75a.75.75 0 010 1.5h-.75a.75.75 0 01-.75-.75zM11.25 16a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H10V14a.75.75 0 011.5 0v2zM14 11.25a.75.75 0 01.75-.75h.75a.75.75 0 010 1.5h-.75a.75.75 0 01-.75-.75z" /></svg>`,
    };

    const fertilizerPrices = { "यूरिया": 9, "DAP": 48, "MOP (पोटाश)": 28, "SSP": 15, "सल्फर": 20, "जिप्सम": 10, "जिंक सल्फेट": 80, "बोरॉन": 150, "गोबर की खाद": 2, "वर्मीकम्पोस्ट": 12 };

    const cropDatabase = {
        "गेहूँ": { season: "रबी", soil: "जलोढ़,काली", base_price: 2450, base_yield: 18, fertilizer: [{n:"यूरिया",q:120},{n:"DAP",q:60},{n:"MOP (पोटाश)",q:20}], sustainable: "जीरो टिलेज, फसल अवशेष प्रबंधन।", calendar: [{w:0,c:"action",t:"खेत की तैयारी और पलेवा"},{w:1,c:"action",t:"बीजोपचार एवं बुवाई"},{w:3,c:"irrigation",t:"पहली सिंचाई (ताजमूल अवस्था)"},{w:6,c:"fertilizer",t:"यूरिया की पहली टॉप ड्रेसिंग"},{w:9,c:"pest_control",t:"खरपतवार नियंत्रण"},{w:12,c:"irrigation",t:"बालियाँ निकलने पर सिंचाई"},{w:20,c:"harvest",t:"कटाई और गहाई"}]},
        "धान": { season: "खरीफ", soil: "जलोढ़,काली,लाल", base_price: 2100, base_yield: 22, fertilizer: [{n:"यूरिया",q:100},{n:"DAP",q:50},{n:"जिंक सल्फेट",q:10}], sustainable: "सीधी बिजाई (DSR), नीम लेपित यूरिया।", calendar: [{w:0,c:"action",t:"नर्सरी की तैयारी"},{w:3,c:"action",t:"खेत की मचाई और रोपाई"},{w:4,c:"pest_control",t:"खरपतवारनाशक का प्रयोग"},{w:6,c:"fertilizer",t:"यूरिया की टॉप ड्रेसिंग"},{w:10,c:"pest_control",t:"तना छेदक की निगरानी"},{w:16,c:"harvest",t:"कटाई"}]},
        "मक्का": { season: "खरीफ,जायद", soil: "जलोढ़,लाल,लेटराइट", base_price: 2200, base_yield: 25, fertilizer: [{n:"यूरिया",q:80},{n:"DAP",q:50}], sustainable: "दलहनी फसलों के साथ सह-फसली।", calendar: [{w:1,c:"action",t:"बुवाई"},{w:4,c:"irrigation",t:"घुटने तक की अवस्था में सिंचाई"},{w:5,c:"fertilizer",t:"नाइट्रोजन की टॉप ड्रेसिंग"},{w:9,c:"pest_control",t:"फॉल आर्मीवर्म की निगरानी"},{w:18,c:"harvest",t:"कटाई"}]},
        "चना": { season: "रबी", soil: "काली,जलोढ़", base_price: 5500, base_yield: 8, fertilizer: [{n:"DAP",q:40},{n:"सल्फर",q:8}], sustainable: "राइजोबियम कल्चर से बीजोपचार करें।", calendar: [{w:1,c:"action",t:"राइजोबियम से बीजोपचार व बुवाई"},{w:6,c:"irrigation",t:"फूल आने से पहले सिंचाई"},{w:12,c:"pest_control",t:"फली छेदक की निगरानी"},{w:22,c:"harvest",t:"कटाई"}]},
        "सरसों": { season: "रबी", soil: "जलोढ़,लेटराइट", base_price: 5800, base_yield: 10, fertilizer: [{n:"यूरिया",q:70},{n:"SSP",q:100},{n:"सल्फर",q:10}], sustainable: "मधुमक्खी पालन से परागण को बढ़ावा दें।", calendar: [{w:1,c:"action",t:"बुवाई"},{w:5,c:"action",t:"घनी फसल की छँटाई"},{w:7,c:"irrigation",t:"फूल आने पर सिंचाई"},{w:11,c:"pest_control",t:"माहू (एफिड) की निगरानी"},{w:20,c:"harvest",t:"कटाई"}]},
        "कपास": { season: "खरीफ", soil: "काली,जलोढ़", base_price: 7100, base_yield: 7, fertilizer: [{n:"यूरिया",q:90},{n:"DAP",q:50},{n:"MOP (पोटाश)",q:25}], sustainable: "फेरोमोन ट्रैप का प्रयोग करें।", calendar: [{w:1,c:"action",t:"बुवाई"},{w:9,c:"pest_control",t:"गुलाबी सुंडी की निगरानी"},{w:12,c:"fertilizer",t:"फूल आने पर यूरिया की खुराक"},{w:25,c:"harvest",t:"पहली चुनाई"}]},
        "टमाटर": { season: "रबी,जायद", soil: "जलोढ़,लाल,काली", base_price: 2500, base_yield: 150, fertilizer: [{n:"वर्मीकम्पोस्ट",q:1000},{n:"DAP",q:60},{n:"MOP (पोटाश)",q:40}], sustainable: "मल्चिंग और ड्रिप इरिगेशन का उपयोग।", calendar: [{w:0,c:"action",t:"नर्सरी तैयार करना"},{w:4,c:"action",t:"खेत में रोपाई और सहारा देना"},{w:6,c:"pest_control",t:"फल छेदक कीट की निगरानी"},{w:9,c:"fertilizer",t:"पोटाश की टॉप ड्रेसिंग"},{w:12,c:"harvest",t:"पहली तुड़ाई"}]},
        "प्याज": { season: "रबी,खरीफ", soil: "जलोढ़,लाल", base_price: 3200, base_yield: 120, fertilizer: [{n:"यूरिया",q:80},{n:"SSP",q:120},{n:"MOP (पोटाश)",q:40}], sustainable: "भंडारण में नुकसान कम करने के उपाय।", calendar: [{w:0,c:"action",t:"नर्सरी में बीज डालना"},{w:6,c:"action",t:"खेत में रोपाई"},{w:10,c:"pest_control",t:"थ्रिप्स की निगरानी"},{w:20,c:"harvest",t:"खुदाई और सुखाना"}]},
        "आलू": { season: "रबी", soil: "जलोढ़,लेटराइट", base_price: 1800, base_yield: 130, fertilizer: [{n:"यूरिया",q:120},{n:"DAP",q:80},{n:"MOP (पोटाश)",q:50}], sustainable: "अगेती और पछेती झुलसा का प्रबंधन।", calendar: [{w:1,c:"action",t:"कंद उपचार और बुवाई"},{w:5,c:"action",t:"मिट्टी चढ़ाना (Earthing up)"},{w:8,c:"pest_control",t:"पछेती झुलसा की निगरानी"},{w:15,c:"harvest",t:"खुदाई"}]},
        "गन्ना": { season: "खरीफ,जायद", soil: "काली,जलोढ़,लाल", base_price: 350, base_yield: 400, fertilizer: [{n:"यूरिया",q:150},{n:"SSP",q:200}], sustainable: "सहफसली खेती (जैसे प्याज, लहसुन)।", calendar: [{w:1,c:"action",t:"बुवाई"},{w:8,c:"pest_control",t:"खरपतवार नियंत्रण"},{w:16,c:"action",t:"गन्ने की बंधाई"},{w:48,c:"harvest",t:"कटाई"}]},
        "सोयाबीन": { season: "खरीफ", soil: "काली,जलोढ़", base_price: 4800, base_yield: 10, fertilizer: [{n:"SSP",q:120},{n:"MOP (पोटाश)",q:20}], sustainable: "रिज-फरो विधि से बुवाई।", calendar: [{w:1,c:"action",t:"बुवाई"},{w:5,c:"pest_control",t:"गर्डल बीटल की निगरानी"},{w:16,c:"harvest",t:"कटाई"}]},
        "मूंगफली": { season: "खरीफ,जायद", soil: "लाल,लेटराइट,जलोढ़", base_price: 6000, base_yield: 9, fertilizer: [{n:"जिप्सम",q:100},{n:"SSP",q:100}], sustainable: "कैल्शियम की पूर्ति हेतु जिप्सम का प्रयोग।", calendar: [{w:1,c:"action",t:"बुवाई"},{w:6,c:"fertilizer",t:"फूल आने पर जिप्सम डालना"},{w:18,c:"harvest",t:"खुदाई"}]},
        "बाजरा": { season: "खरीफ", soil: "लेटराइट,जलोढ़", base_price: 2300, base_yield: 9, fertilizer: [{n:"यूरिया",q:40},{n:"SSP",q:60}], sustainable: "कम पानी में उगने वाली किस्मों का चयन।", calendar: [{w:1,c:"action",t:"बुवाई"},{w:5,c:"pest_control",t:"तना मक्खी की निगरानी"},{w:15,c:"harvest",t:"कटाई"}]},
        "ज्वार": { season: "खरीफ", soil: "काली,लाल", base_price: 2200, base_yield: 12, fertilizer: [{n:"यूरिया",q:50},{n:"SSP",q:80}], sustainable: "चारे और दाने दोनों के लिए उपयोग।", calendar: [{w:1,c:"action",t:"बुवाई"},{w:6,c:"pest_control",t:"प्ररोह मक्खी का नियंत्रण"},{w:18,c:"harvest",t:"कटाई"}]},
        "मूंग": { season: "खरीफ,जायद", soil: "जलोढ़,काली", base_price: 7500, base_yield: 5, fertilizer: [{n:"DAP",q:40}], sustainable: "फसल चक्र में शामिल करने से मिट्टी का स्वास्थ्य सुधरता है।", calendar: [{w:1,c:"action",t:"बुवाई"},{w:5,c:"pest_control",t:"पीला मोजेक रोग की निगरानी"},{w:10,c:"harvest",t:"पहली तुड़ाई"}]},
        "मिर्च": { season: "खरीफ,जायद", soil: "लाल,काली,जलोढ़", base_price: 8000, base_yield: 60, fertilizer: [{n:"वर्मीकम्पोस्ट",q:800},{n:"MOP (पोटाश)",q:30}], sustainable: "एफिड्स के लिए स्टिकी ट्रैप का उपयोग।", calendar: [{w:0,c:"action",t:"नर्सरी की तैयारी"},{w:5,c:"action",t:"रोपाई"},{w:9,c:"pest_control",t:"थ्रिप्स और माइट्स की निगरानी"},{w:14,c:"harvest",t:"पहली तुड़ाई"}]},
        "हल्दी": { season: "खरीफ", soil: "लाल,लेटराइट", base_price: 9000, base_yield: 80, fertilizer: [{n:"गोबर की खाद",q:4000},{n:"यूरिया",q:60}], sustainable: "छायादार जगह में उगाना फायदेमंद।", calendar: [{w:1,c:"action",t:"कंद की बुवाई"},{w:8,c:"action",t:"मिट्टी चढ़ाना"},{w:36,c:"harvest",t:"खुदाई और उबालना"}]},
        "लहसुन": { season: "रबी", soil: "जलोढ़,काली", base_price: 12000, base_yield: 40, fertilizer: [{n:"यूरिया",q:50},{n:"SSP",q:100}], sustainable: "जैविक कीटनाशकों का प्रयोग।", calendar: [{w:1,c:"action",t:"कलियों की बुवाई"},{w:6,c:"irrigation",t:"सिंचाई"},{w:20,c:"harvest",t:"खुदाई"}]},
        "केला": { season: "खरीफ", soil: "जलोढ़,लाल", base_price: 1500, base_yield: 300, fertilizer: [{n:"यूरिया",q:100},{n:"MOP (पोटाश)",q:120}], sustainable: "ड्रिप सिंचाई और फर्टिगेशन।", calendar: [{w:1,c:"action",t:"पौधों की रोपाई"},{w:16,c:"action",t:"सहारा देना (Propping)"},{w:40,c:"harvest",t:"घार की कटाई"}]},
        "पपीता": { season: "खरीफ,जायद", soil: "जलोढ़,लाल", base_price: 2000, base_yield: 400, fertilizer: [{n:"गोबर की खाद",q:2000},{n:"यूरिया",q:80}], sustainable: "रिंग स्पॉट वायरस से बचाव।", calendar: [{w:1,c:"action",t:"रोपाई"},{w:20,c:"pest_control",t:"मिलिबग की निगरानी"},{w:36,c:"harvest",t:"फलों की तुड़ाई"}]},
        "बैंगन": { season: "खरीफ,जायद,रबी", soil: "जलोढ़,काली", base_price: 1800, base_yield: 140, fertilizer: [{n:"यूरिया",q:60},{n:"SSP",q:100}], sustainable: "तना और फल छेदक के लिए फेरोमोन ट्रैप।", calendar: [{w:0,c:"action",t:"नर्सरी"},{w:5,c:"action",t:"रोपाई"},{w:10,c:"pest_control",t:"तना छेदक की निगरानी"},{w:14,c:"harvest",t:"पहली तुड़ाई"}]},
        "भिंडी": { season: "खरीफ,जायद", soil: "जलोढ़,लाल", base_price: 2500, base_yield: 50, fertilizer: [{n:"यूरिया",q:40},{n:"DAP",q:40}], sustainable: "पीला मोजेक प्रतिरोधी किस्मों का उपयोग।", calendar: [{w:1,c:"action",t:"बुवाई"},{w:5,c:"pest_control",t:"सफेद मक्खी की निगरानी"},{w:8,c:"harvest",t:"तुड़ाई शुरू"}]},
        "पत्ता गोभी": { season: "रबी", soil: "जलोढ़,काली", base_price: 1200, base_yield: 120, fertilizer: [{n:"यूरिया",q:80},{n:"DAP",q:60},{n:"बोरॉन",q:2}], sustainable: "डायमंड बैक मोथ के लिए जैविक नियंत्रण।", calendar: [{w:0,c:"action",t:"नर्सरी"},{w:4,c:"action",t:"रोपाई"},{w:8,c:"pest_control",t:"सुंडी की निगरानी"},{w:12,c:"harvest",t:"कटाई"}]},
        "फूलगोभी": { season: "रबी", soil: "जलोढ़,लाल", base_price: 1500, base_yield: 100, fertilizer: [{n:"यूरिया",q:70},{n:"SSP",q:120},{n:"बोरॉन",q:2}], sustainable: "बोरॉन की कमी से बचाव।", calendar: [{w:0,c:"action",t:"नर्सरी"},{w:4,c:"action",t:"रोपाई"},{w:9,c:"action",t:"ब्लांचिंग (फूल को ढकना)"},{w:13,c:"harvest",t:"कटाई"}]},
        "गुलाब": { season: "रबी", soil: "जलोढ़,काली", base_price: 1500, base_yield: 50, fertilizer: [{n:"वर्मीकम्पोस्ट", q:500},{n:"DAP", q:20}], sustainable: "नियमित कटाई-छंटाई और रोग प्रबंधन।", calendar: [{w:1,c:"action",t:"छंटाई (Pruning)"},{w:7,c:"pest_control", t:"पाउडरी मिल्ड्यू की निगरानी"},{w:10,c:"harvest",t:"फूलों की तुड़ाई"}]}
    };
    
    const allElements = {
        cityInput: document.getElementById('cityInput'),
        getWeatherBtn: document.getElementById('getWeatherBtn'),
        weatherResult: document.getElementById('weatherResult'),
        irrigationAdvisory: document.getElementById('irrigationAdvisory'),
        getCropBtn: document.getElementById('getCropBtn'),
        cropResult: document.getElementById('cropResult'),
        diagnoseBtn: document.getElementById('diagnoseBtn'),
        diagnosisResult: document.getElementById('diagnosisResult'),
        getMarketPriceBtn: document.getElementById('getMarketPriceBtn'),
        marketPriceResult: document.getElementById('marketPriceResult'),
        predictYieldBtn: document.getElementById('predictYieldBtn'),
        yieldResult: document.getElementById('yieldResult'),
        addIncomeBtn: document.getElementById('addIncomeBtn'),
        addExpenseBtn: document.getElementById('addExpenseBtn'),
        profitText: document.getElementById('profitText'),
        transactionList: document.getElementById('transactionList'),
        postQuestionBtn: document.getElementById('postQuestionBtn'),
        forumPosts: document.getElementById('forumPosts'),
        getFertilizerBtn: document.getElementById('getFertilizerBtn'),
        fertilizerResult: document.getElementById('fertilizerResult'),
        generateCalendarBtn: document.getElementById('generateCalendarBtn'),
        openCostCalculatorBtn: document.getElementById('openCostCalculatorBtn'),
        costCalculatorModal: document.getElementById('costCalculatorModal'),
        closeCostModalBtn: document.getElementById('closeCostModalBtn'),
        calculateCostBtn: document.getElementById('calculateCostBtn'),
        totalCostResult: document.getElementById('totalCostResult'),
        calendarModal: document.getElementById('calendarModal'),
        closeCalendarModalBtn: document.getElementById('closeCalendarModalBtn'),
        modalContent: document.getElementById('modalContent'),
        modalTitle: document.getElementById('modalTitle'),
        assistantBtn: document.getElementById('assistantBtn'),
        status: document.getElementById('status'),
    };
    
    let ledger = [];
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'hi-IN';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
    }
    let isListening = false;
    let synth = window.speechSynthesis;

    function speak(text) {
        if (synth.speaking) {
            synth.cancel();
        }
        const utterThis = new SpeechSynthesisUtterance(text);
        utterThis.lang = 'hi-IN';
        utterThis.pitch = 1;
        utterThis.rate = 1;
        synth.speak(utterThis);
    }

    function showMessage(text, type = 'info') {
        const box = document.getElementById('messageBox');
        box.textContent = text;
        const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500' };
        box.className = `fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl shadow-lg z-50 text-white transition-opacity duration-300 opacity-100 ${colors[type]}`;
        setTimeout(() => { box.style.opacity = '0'; }, 3000);
    }
    
    function populateDropdowns() {
        const cropNames = Object.keys(cropDatabase).sort();
        const selects = [
            document.getElementById('calendarCrop'), document.getElementById('marketCropSelect'),
            document.getElementById('yieldCrop'), document.getElementById('fertilizerCrop')
        ];
        selects.forEach(select => {
            if(select) {
                select.innerHTML = '';
                cropNames.forEach(crop => {
                    const option = document.createElement('option');
                    option.value = crop; option.textContent = crop;
                    select.appendChild(option);
                });
            }
        });
    }

    const fetchWeather = async (cityOverride = null) => {
        const city = cityOverride || allElements.cityInput.value.trim();
        if (!city) {
            showMessage("कृपया शहर का नाम दर्ज करें।", "error");
            return;
        }
        allElements.weatherResult.innerHTML = `<div class="flex justify-center"><div class="loader"></div></div>`;
        allElements.irrigationAdvisory.innerHTML = '';
        allElements.cityInput.value = city;
        
        try {
            const API_KEY = "2aa75c3847bdda09f365c8b688902505"; // Demo key
            const [weatherResponse, forecastResponse] = await Promise.all([
                fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${API_KEY}&units=metric&lang=hi`),
                fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${city}&appid=${API_KEY}&units=metric&lang=hi`)
            ]);

            if (!weatherResponse.ok || !forecastResponse.ok) throw new Error("API request failed");
            
            const weatherData = await weatherResponse.json();
            const forecastData = await forecastResponse.json();
            
            processWeatherData(weatherData);
            processForecastData(forecastData);

        } catch (error) {
            console.warn("Live API failed, using simulated data.", error);
            showMessage("लाइव डेटा विफल, सिम्युलेटेड डेटा का उपयोग कर रहे हैं।", "warning");
            setTimeout(() => {
                const simulatedWeather = { name: city, main: { temp: 31.5 }, weather: [{ description: "धूप", icon: "01d" }], rain: null };
                const simulatedForecast = { list: [
                    { dt_txt: "2025-09-29 12:00:00", main: { temp_max: 32, temp_min: 25 }, weather: [{ icon: '02d' }] },
                    { dt_txt: "2025-09-30 12:00:00", main: { temp_max: 33, temp_min: 26 }, weather: [{ icon: '01d' }] },
                    { dt_txt: "2025-10-01 12:00:00", main: { temp_max: 31, temp_min: 24 }, weather: [{ icon: '10d' }] },
                    { dt_txt: "2025-10-02 12:00:00", main: { temp_max: 30, temp_min: 23 }, weather: [{ icon: '04d' }] },
                    { dt_txt: "2025-10-03 12:00:00", main: { temp_max: 32, temp_min: 25 }, weather: [{ icon: '01d' }] }
                ]};
                processWeatherData(simulatedWeather);
                processForecastData(simulatedForecast);
            }, 1000);
        }
    };
    
    function processWeatherData(data) {
        allElements.weatherResult.innerHTML = `<div class="p-3 bg-blue-50 rounded-lg">
            <h4 class="font-bold text-lg text-blue-800">${data.name}</h4>
            <div class="flex items-center gap-2">
                <img src="https://openweathermap.org/img/wn/${data.weather[0].icon}.png" alt="weather icon" class="h-10 w-10">
                <p class="text-2xl font-semibold">${data.main.temp.toFixed(1)}°C</p>
                <p>${data.weather[0].description}</p>
            </div>
        </div>
        <div id="forecastResult" class="mt-4"></div>`;
        
        let irrigationText = '';
        if (data.main.temp > 32 && (!data.rain || !data.rain['1h'])) {
            irrigationText = 'तापमान अधिक है और बारिश की संभावना कम है। खेत में नमी की जाँच करें और आवश्यकतानुसार सिंचाई करें।';
        } else if (data.rain && data.rain['1h'] > 5) {
            irrigationText = 'भारी बारिश की संभावना है। अभी सिंचाई करने की आवश्यकता नहीं है। जल निकासी की व्यवस्था करें।';
        } else {
            irrigationText = 'मौसम सामान्य है। मिट्टी की नमी के अनुसार सिंचाई का निर्णय लें।';
        }
        allElements.irrigationAdvisory.innerHTML = `<div class="p-3 bg-indigo-50 rounded-lg mt-2"><p class="font-bold text-indigo-800">सिंचाई सलाह:</p><p class="text-sm">${irrigationText}</p></div>`;
    }

    function processForecastData(data) {
        const forecastResult = document.getElementById('forecastResult');
        if (!forecastResult) return;
        
        const dailyData = data.list.filter(item => item.dt_txt.includes("12:00:00"));

        let forecastHtml = `<h4 class="font-bold text-gray-700 mb-2">अगले 5 दिनों का पूर्वानुमान:</h4><div class="grid grid-cols-5 gap-1 text-center">`;
        dailyData.slice(0, 5).forEach(day => {
            const date = new Date(day.dt_txt);
            const dayName = date.toLocaleDateString('hi-IN', { weekday: 'short' });
            forecastHtml += `<div class="p-1 bg-gray-100 rounded">
                <p class="font-semibold text-sm">${dayName}</p>
                <img src="https://openweathermap.org/img/wn/${day.weather[0].icon}.png" alt="icon" class="mx-auto h-8 w-8">
                <p class="text-xs">${day.main.temp_max.toFixed(0)}°/${day.main.temp_min.toFixed(0)}°</p>
            </div>`;
        });
        forecastHtml += `</div>`;
        forecastResult.innerHTML = forecastHtml;
    }

    const getCropAdvice = (soilOverride = null, seasonOverride = null) => {
        const soil = soilOverride || document.getElementById('soilType').value;
        const season = seasonOverride || document.getElementById('season').value;

        if(soilOverride) document.getElementById('soilType').value = soilOverride;
        if(seasonOverride) document.getElementById('season').value = seasonOverride;

        const suggestedCrops = Object.keys(cropDatabase).filter(crop => {
            const data = cropDatabase[crop];
            return data.soil.includes(soil) && data.season.includes(season);
        });

        if (suggestedCrops.length > 0) {
            const resultText = `सुझाए गए फसलें हैं: ${suggestedCrops.join(', ')}`;
            allElements.cropResult.innerHTML = `<p class="font-bold">आपके लिए सुझाए गए फसलें:</p><ul class="list-disc list-inside">${suggestedCrops.map(c => `<li>${c}</li>`).join('')}</ul>`;
            if(soilOverride) speak(resultText);
        } else {
            allElements.cropResult.innerHTML = `<p>इस संयोजन के लिए कोई फसल नहीं मिली।</p>`;
            if(soilOverride) speak("इस संयोजन के लिए कोई फसल नहीं मिली।");
        }
    };
    
    const getFertilizerInfo = (cropOverride = null) => {
        const cropName = cropOverride || document.getElementById('fertilizerCrop').value;
        if(cropOverride) document.getElementById('fertilizerCrop').value = cropName;

        const data = cropDatabase[cropName];
        if (!data) return;

        let totalCost = 0;
        let speakText = `${cropName} के लिए, `;
        let fertilizerHtml = data.fertilizer.map(f => {
            const price = fertilizerPrices[f.n] || 0;
            const cost = price * f.q;
            totalCost += cost;
            speakText += `${f.q} किलोग्राम ${f.n}, `;
            return `<li class="flex justify-between"><span>- ${f.n} (${f.q} kg)</span> <span class="font-semibold">~₹${cost.toLocaleString('en-IN')}</span></li>`;
        }).join('');

        const resultHtml = `<div class="p-3 bg-blue-50 rounded-lg mb-3">
                              <h4 class="font-bold text-blue-800">उर्वरक सुझाव (प्रति एकड़):</h4>
                              <ul class="text-sm list-none space-y-1 mt-2">${fertilizerHtml}</ul>
                              <hr class="my-2"><p class="flex justify-between font-bold"><span>कुल लागत</span><span>~₹${totalCost.toLocaleString('en-IN')}</span></p>
                           </div>
                           <div class="p-3 bg-yellow-50 rounded-lg">
                              <h4 class="font-bold text-yellow-800">टिकाऊ खेती:</h4>
                              <p class="text-sm">${data.sustainable}</p>
                           </div>`;
        allElements.fertilizerResult.innerHTML = resultHtml;
        if (cropOverride) speak(speakText + `की आवश्यकता होगी।`);
    };

    const generateCalendar = (cropOverride = null) => {
        const crop = cropOverride || document.getElementById('calendarCrop').value;
        if(cropOverride) document.getElementById('calendarCrop').value = crop;

        const dateStr = document.getElementById('sowingDate').value;
        if (!dateStr) { 
            showMessage("कृपया बुवाई की तारीख चुनें।", "error");
            if (!cropOverride) speak("कृपया पहले बुवाई की तारीख चुनें।");
            else speak(`${crop} का कैलेंडर देखने के लिए, कृपया बुवाई की तारीख चुनें और फिर बटन दबाएं।`);
            return;
        }
        const startDate = new Date(dateStr);
        const data = cropDatabase[crop];
        
        allElements.modalTitle.innerText = `${crop} - फसल कैलेंडर`;
        let content = `<div class="timeline">` + data.calendar.map(item => {
            const taskDate = new Date(startDate);
            taskDate.setDate(startDate.getDate() + (item.w * 7));
            const icon = ICONS[item.c] || ICONS['action'];
            const categoryColor = { fertilizer: 'bg-yellow-400', irrigation: 'bg-blue-400', pest_control: 'bg-red-400', harvest: 'bg-green-400', action: 'bg-gray-400'}[item.c];

            return `<div class="timeline-item">
                       <div class="timeline-icon ${categoryColor}">${icon}</div>
                       <div class="timeline-content">
                           <p class="timeline-category">सप्ताह ${item.w} (${taskDate.toLocaleDateString('hi-IN', {day:'2-digit', month:'short'})})</p>
                           <p>${item.t}</p>
                       </div>
                   </div>`;
        }).join('') + `</div>`;
        
        allElements.modalContent.innerHTML = content;
        allElements.calendarModal.classList.remove('hidden');
        allElements.calendarModal.classList.add('flex');
    };
    
    const diagnosePlant = () => {
        const fileInput = document.getElementById('plantPhotoInput');
        if (!fileInput.files || fileInput.files.length === 0) {
            showMessage("कृपया एक फोटो चुनें।", "error");
            return;
        }

        allElements.diagnosisResult.innerHTML = `<div class="flex items-center gap-2"><div class="loader !w-6 !h-6"></div><p>विश्लेषण किया जा रहा है...</p></div>`;
        
        setTimeout(() => {
            const diseases = [
                { name: "लीफ कर्ल वायरस", remedy: "सफेद मक्खी नियंत्रण के लिए इमिडाक्लोप्रिड का छिड़काव करें।", confidence: 92 },
                { name: "पाउडरी मिल्ड्यू", remedy: "सल्फर आधारित फफूंदनाशक का प्रयोग करें।", confidence: 88 },
                { name: "नाइट्रोजन की कमी", remedy: "यूरिया की टॉप ड्रेसिंग करें या NPK घोल का छिड़काव करें।", confidence: 95 }
            ];
            const result = diseases[Math.floor(Math.random() * diseases.length)];
            allElements.diagnosisResult.innerHTML = `<div class="p-2 bg-yellow-50 rounded-lg">
                <p><span class="font-bold">संभावित समस्या:</span> ${result.name} (${result.confidence}% संभावना)</p>
                <p><span class="font-bold">सुझाव:</span> ${result.remedy}</p>
            </div>`;
        }, 2000);
    };

    const getMarketPrice = () => {
        const crop = document.getElementById('marketCropSelect').value;
        const city = document.getElementById('cityInputMarket').value || "प्रमुख मंडी";
        const basePrice = cropDatabase[crop].base_price;
        const currentPrice = basePrice + Math.floor(Math.random() * (basePrice * 0.1) - (basePrice * 0.05));
        const trend = Math.random() > 0.5 ? "बढ़ने" : "स्थिर रहने";

        allElements.marketPriceResult.innerHTML = `<div class="p-2 bg-gray-100 rounded-lg">
            <p>${city} में ${crop} का वर्तमान औसत मूल्य:</p>
            <p class="text-xl font-bold text-green-700">₹ ${currentPrice.toLocaleString('en-IN')} / क्विंटल</p>
            <p class="text-sm mt-2">अगले 7 दिनों में कीमतों के ${trend} की संभावना है।</p>
        </div>`;
    };

    const predictYield = () => {
        const crop = document.getElementById('yieldCrop').value;
        const size = parseFloat(document.getElementById('farmSize').value) || 0;
        if (size <= 0) {
            showMessage("कृपया खेत का आकार दर्ज करें।", "error");
            return;
        }
        const baseYield = cropDatabase[crop].base_yield;
        const predictedYield = (baseYield * size).toFixed(2);
        allElements.yieldResult.innerHTML = `<div class="p-2 bg-green-50 rounded-lg text-center">
            <p>अनुमानित उपज:</p>
            <p class="text-xl font-bold">${predictedYield} क्विंटल</p>
        </div>`;
    };

    const updateLedger = () => {
        let total = 0;
        allElements.transactionList.innerHTML = '';
        ledger.forEach(t => {
            total += t.amount;
            const item = document.createElement('div');
            item.className = `flex justify-between p-1 rounded ${t.amount > 0 ? 'bg-green-100' : 'bg-red-100'}`;
            item.innerHTML = `<span>${t.desc}</span><span>₹ ${t.amount.toLocaleString('en-IN')}</span>`;
            allElements.transactionList.appendChild(item);
        });
        allElements.profitText.textContent = `₹ ${total.toLocaleString('en-IN')}`;
        allElements.profitText.className = `text-2xl font-bold ${total >= 0 ? 'text-green-700' : 'text-red-600'}`;
    };

    const addTransaction = (type) => {
        const desc = document.getElementById('transactionDesc').value;
        let amount = parseFloat(document.getElementById('transactionAmount').value);
        if (!desc || isNaN(amount) || amount <= 0) {
            showMessage("कृपया सही विवरण और राशि दर्ज करें।", "error");
            return;
        }
        if (type === 'expense') amount = -amount;
        ledger.push({ desc, amount });
        updateLedger();
        document.getElementById('transactionDesc').value = '';
        document.getElementById('transactionAmount').value = '';
    };

    const postToForum = () => {
        const question = document.getElementById('forumQuestion').value;
        if (!question.trim()) {
             showMessage("कृपया अपना सवाल लिखें।", "error");
             return;
        }
        const post = document.createElement('div');
        post.className = "p-3 bg-blue-50 rounded-lg";
        post.innerHTML = `<p class="font-bold text-sm">आपने पूछा:</p><p class="text-sm">${question}</p>`;
        allElements.forumPosts.appendChild(post);
        document.getElementById('forumQuestion').value = '';
        allElements.forumPosts.scrollTop = allElements.forumPosts.scrollHeight;
    };

    const calculateTotalCost = () => {
        const ids = ["cost_seed", "cost_fertilizer", "cost_pesticide", "cost_labor", "cost_irrigation", "cost_other"];
        const total = ids.reduce((sum, id) => {
            const value = parseFloat(document.getElementById(id).value) || 0;
            return sum + value;
        }, 0);
        allElements.totalCostResult.innerHTML = `कुल अनुमानित लागत: <span class="text-blue-700">₹ ${total.toLocaleString('en-IN')}</span>`;
    };
    
    function handleVoiceCommand(transcript) {
        console.log("Transcript:", transcript);
        transcript = transcript.toLowerCase();

        if (transcript.includes('मौसम')) {
            const cities = ["दिल्ली", "मुंबई", "पुणे", "जयपुर", "लखनऊ", "पटना", "भोपाल", "इंदौर", "ग्रेटर नोएडा"];
            let foundCity = null;
            cities.forEach(city => {
                if (transcript.includes(city.toLowerCase())) {
                    foundCity = city;
                }
            });
            if (foundCity) {
                speak(`${foundCity} का मौसम दिखा रहा हूँ।`);
                fetchWeather(foundCity);
            } else {
                speak("कृपया शहर का नाम बताएं।");
            }
            return;
        }

        if (transcript.includes('फसल बताओ') || transcript.includes('फसल सुझाओ')) {
            const soils = { "काली": "काली", "जलोढ़": "जलोढ़", "लाल": "लाल", "लेटराइट": "लेटराइट" };
            const seasons = { "रबी": "रबी", "खरीफ": "खरीफ", "जायद": "जायद" };
            let foundSoil = null, foundSeason = null;
            Object.keys(soils).forEach(s => { if(transcript.includes(s)) foundSoil = soils[s]; });
            Object.keys(seasons).forEach(s => { if(transcript.includes(s)) foundSeason = seasons[s]; });
            
            if (foundSoil && foundSeason) {
                speak(`${foundSoil} मिट्टी और ${foundSeason} मौसम के लिए फसल बता रहा हूँ।`);
                getCropAdvice(foundSoil, foundSeason);
            } else {
                speak("फसल सुझाव के लिए, कृपया मिट्टी का प्रकार और मौसम बताएं। जैसे, 'काली मिट्टी और खरीफ के लिए फसल बताओ'");
            }
            return;
        }

        if (transcript.includes('कैलेंडर')) {
            let foundCrop = null;
            Object.keys(cropDatabase).forEach(crop => {
                if (transcript.includes(crop.toLowerCase())) {
                    foundCrop = crop;
                }
            });
            if (foundCrop) {
                generateCalendar(foundCrop);
            } else {
                speak("कृपया फसल का नाम बताएं जिसका कैलेंडर आप देखना चाहते हैं।");
            }
            return;
        }

        if (transcript.includes('खाद')) {
            let foundCrop = null;
            Object.keys(cropDatabase).forEach(crop => {
                if (transcript.includes(crop.toLowerCase())) {
                    foundCrop = crop;
                }
            });
            if (foundCrop) {
                speak(`${foundCrop} के लिए खाद की जानकारी दे रहा हूँ।`);
                getFertilizerInfo(foundCrop);
            } else {
                speak("कृपया फसल का नाम बताएं जिसकी खाद की जानकारी चाहिए।");
            }
            return;
        }
        
        speak("माफ़ कीजिये, मैं समझ नहीं पाया। क्या आप दोहरा सकते हैं?");
    }

    // --- EVENT LISTENERS ---
    if (recognition) {
        allElements.assistantBtn.addEventListener('click', () => {
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

        recognition.onstart = () => {
            isListening = true;
            allElements.status.textContent = "सुन रहा हूँ...";
            allElements.assistantBtn.classList.add('assistant-btn-glow');
            speak("नमस्ते, मैं हरित हूँ। आप क्या जानना चाहते हैं?");
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            allElements.status.textContent = `आपने कहा: ${transcript}`;
            handleVoiceCommand(transcript);
        };

        recognition.onerror = (event) => {
            console.error(event.error);
            allElements.status.textContent = "एक त्रुटि हुई, कृपया पुनः प्रयास करें।";
        };

        recognition.onend = () => {
            isListening = false;
            allElements.status.textContent = "";
            allElements.assistantBtn.classList.remove('assistant-btn-glow');
        };
    } else {
        allElements.status.textContent = "आपका ब्राउज़र वॉयस असिस्टेंट को सपोर्ट नहीं करता है।";
    }
    
    allElements.getWeatherBtn.addEventListener('click', () => fetchWeather());
    allElements.getCropBtn.addEventListener('click', () => getCropAdvice());
    allElements.getFertilizerBtn.addEventListener('click', () => getFertilizerInfo());
    allElements.generateCalendarBtn.addEventListener('click', () => generateCalendar());
    allElements.diagnoseBtn.addEventListener('click', diagnosePlant);
    allElements.getMarketPriceBtn.addEventListener('click', getMarketPrice);
    allElements.predictYieldBtn.addEventListener('click', predictYield);
    allElements.addIncomeBtn.addEventListener('click', () => addTransaction('income'));
    allElements.addExpenseBtn.addEventListener('click', () => addTransaction('expense'));
    allElements.postQuestionBtn.addEventListener('click', postToForum);
    allElements.calculateCostBtn.addEventListener('click', calculateTotalCost);
    
    allElements.openCostCalculatorBtn.addEventListener('click', () => allElements.costCalculatorModal.classList.remove('hidden'));
    allElements.closeCostModalBtn.addEventListener('click', () => allElements.costCalculatorModal.classList.add('hidden'));
    allElements.closeCalendarModalBtn.addEventListener('click', () => allElements.calendarModal.classList.add('hidden'));

    // --- INITIALIZATION ---
    populateDropdowns();
    document.getElementById('sowingDate').valueAsDate = new Date();
});
</script>
</body>
</html>
